# ✍🏻 2. SQL 튜닝 용어를 직관적으로 이해하기
# 2.1 물리 엔진과 오브젝트 용어
이 절에선 SQL 튜닝에 필요한 용어들을 거시적 관점에서 소개합니다.
## DB 엔진 용어
사용자는 DB에서 원하는 데이터를 가져오고자 SQL문을 실행합니다.

실행된 SQL문은 MySQL 엔진에서 문법 에러가 있는지, DB에 존재하는 테이블 대상으로 SQL문을 작성했는지와 같은 세부 사항을 다양한 문법 및 구문으로 검사합니다. (파싱 작업을 하는 파서, parser 역할)

이후 사용자가 요청한 데이터를 빠르고 효율적으로 찾아가는 전략적 계획을 수립합니다. (옵티마이저, optimizer)

이 계획을 토대로 스토리지 엔진에 위치한 데이터까지 찾아간 뒤 해당 데이터를 MySQL 엔진으로 전달합니다.

MySQL 엔진은 전달된 데이터에서 불필요한 부분을 필터링(제거, 변경)하고 필요한 연산을 수행한 뒤 사용자에게 최종 결과를 알려줍니다.

### 스토리지 엔진
(InnoDB, MyISAM, Memory등) 스토리지 엔진은 사용자가 요청한 SQL문을 토대로 DB에 저장된 디스크나 메모리에서 필요한 데이터를 가져오는 역할을 수행합니다.

이후 해당 데이터를 MySQL 엔진으로 보내줍니다.

스토리지 엔진이 데이터를 저장하는 방식에 따라 각각의 스토리지 엔진을 선택하여 사용할 수 있습니다.

주로 InnoDB 엔진을 사용하고, 대량의 쓰기 트랜잭션이 발생하면 MyISAM 엔진, 메모리 데이터를 로드하여 빠르게 읽는 효과를 내려면 Memory 엔진을 사용합니다.

### MySQL 엔진
MySQL 엔진은 사용자가 요청한 SQL문을 넘겨받은 뒤 SQL 문법 검사와 적절한 오브젝트 활용 검사를 하고, SQL 문을 최소 단위로 분리하여 원하는 데이터를 빠르게 찾는 경로를 모색합니다.

이후 스토리지 엔진으로부터 전달받은 데이터 대상으로 불필요한 데이터는 제거하거나 가공 및 연산하는 역할을 합니다.

즉, SQL 문의 시작 및 마무리 단계에 MySQL 엔진이 관여하며, 스토리지 엔진으로부터 필요한 데이터만을 가져오는 핵심 역할을 담당한다고 할 수 있습니다.

## SQL 프로세스 용어
사용자가 SQL문을 수행하면, 파서는 MySQL이 이해할 수 있는 최소 단위로 구성요소를 분리하고 해당 구성요소를 트리로 만든다. 트리로 만들며 문법 오류가 있는지 검사합니다.

이후 전처리기는 생성된 트리 결과를 토대로, 유효성을 검증합니다. (오브젝트가 이미 생성되었는지, 접근 관한이 있는지)

다음으로 옵티마이저는 트리를 구성하는 오브젝트의 데이터를 효율적으로 가져오기 위해 효율적인 경로로 데이터를 검색하는 방법에 관한 실행 계획을 수립합니다.

이후 엔진 실행기는 이전에 수립된 실행 계획으로 스토리지 엔진을 호출해 필요한 데이터를 가져옵니다. 그리고, 스토리지 엔진을 통해서 가져온 데이터 중 불필요한 데이터를 필터링하여 사용자가 원하는 결과를 전달합니다.

## DB 오브젝트 용어
### 테이블
데이터를 저장하는 오브젝트, 관계형 DB는 MySQL은 2차원 배열 형태로 테이블을 관리합니다.

### 로우(행)
테이블에서 동일한 구조의 데이터 항목들의 집합을 가리킵니다.

다른 행 역시 데이터의 값 자체는 다르지만 데이터 항목의 구조는 동일합니다.

### 컬럼(열)
사전에 정의한 데이터 유형으로 데이터 값을 저장하며, 일별로 다른 데이터 유형을 가질 수 있습니다.

### 기본키
PK는 특정 행을 대표하는 열을 가리키는 용어로, 주 키라고도 합니다.

기본키는 각 테이블에서 1개 열만으로 생성하지만 상황에 따라 2개 이상의 열을 조합해 기본 키를 구성할 수도 있습니다.

또한 기본 키는 인덱스 역할도 수행하므로 기본 키를 활용하여 인덱싱할 수 있음을 알고 있어야 합니다.

MySQL에서 기본 키는 클러스터형 인덱스로 작동합니다.

이는 기본 키의 구성 열 순서를 기준으로 물리적인 스토리지에 데이터가 쌓인다는 뜻입니다.

즉, 비슷한 기본 키 값들이 근거리에 적재되므로 기본 키를 활용하여 인덱스 스캔을 수행하면 테이블 데이터에 더 빠르게 접근할 수 있습니다.

### 외래 키
FK는 외부에 있는 테이블을 항상 참조하면서, 외부 테이블의 데이터가 변경되면 함께 영향을 받는 관계를 설정하는 키입니다.

외부 테이블을 부모 테이블, 외부 테이블을 참조하는 테이블을 자식 테이블이라고 생각하면 쉽습니다.

### 인덱스
인덱스는 데이터베이스에서 키 값으로 실제 데이터 위치를 식별하고 데이터 접근 속도를 높이고자 생성하는, 키 기준으로 정렬된 오브젝트입니다.

정렬된 각 키워드가 어느 곳에 있는지를 인덱스라는 이름으로 구성하면, 키워드 검색으로 원하는 페이지를 빠르게 찾을 수 있습니다. 이러한 방식을 DBMS에 차용한게 바로 인덱스입니다.

인덱스는 생성하려는 열의 속성에 따라 고유 인덱스와 비고유 인덱스로 구분할 수 있습니다. 참고로, 흔히 거론되는 인덱스는 비고유 인덱스입니다.

- 고유 인덱스
  - 말 그래도 인덱스를 구성하는 열들의 데이터가 유일하다는 의미입니다. 차례로 정렬되는 인덱스 열의 데이터는 중복되지 않고 유일성을 유지합니다.
  - 예를 들어 연락처(고유한 값)를 인덱스로 설정하는 상황을 들 수 있습니다.
- 비고유 인덱스
  - 고유 인덱스에서 데이터의 유일한 속성만 제외한 키입니다.
  - 데이터가 신규 입력되어 인덱스가 재정렬되더라도 인덱스 열의 중복 체크를 거치지 않고 단순한 정렬 작업을 수행합니다. ex) 이름

# 2.2 논리적인 SQL 개념 용어
이 절에선 SQL 문 작성에 필요한 주변 오브젝트와 SQL문의 상호관계, 연관성과 알고리즘에 관한 논리적 개념 용어를 다룹니다.

## 서브쿼리 위치에 따른 SQL 용어
서브쿼리란 쿼리 안의 보조쿼리를 가리키는 용어입니다.

가장 바깥쪽의 SELECT 문인 메인쿼리를 기준으로 내부에 SELECT 문을 추가로 작성해서 서브쿼리를 만듭니다.

작성하는 위치는 크기 SELECT 절, FROM 절, WHERE 절로 나뉩니다.

- SELECT 절의 서브쿼리 : 주로 메인쿼리의 SELECT 절 내부에 하나의 숫자나 문자, 기호등을 출력하는 SELECT문으로, `스칼라 서브쿼리`라고 합니다.
- FROM 절의 서브쿼리 : `인라인 뷰` 라고 합니다.
- WHERE 절의 서브쿼리 : `중첩 서브쿼리`라고 부릅니다.

### 스칼라 서브쿼리
메인쿼리의 SELECT 절에는 최종 출력하는 열들이 나열되므로, 출력 데이터 1건과 스칼라 서브쿼리의 결과 건수가 일치해야 합니다.

집계함수(max, min, avg, sum, count등)가 자주 쓰입니다.

### 인라인 뷰
인라인 뷰의 결과는 내부적으로 메모리 또는 디스크에 임시 테이블을 생성하여 활용합니다.

### 중첩 서브쿼리
WHERE 절에서 단순한 값을 비교 연산하는 대신, 서브쿼리를 추가하여 비교 연산하기 위해 중첩 서브쿼리를 사용합니다.

보통 비교 연산자 (=, <, >, <=, >=, <>, !=)를 비롯해 IN, EXISTS, NOT IN, NOT EXISTS 문을 많이 사용합니다.

## 메인쿼리와의 관계성에 따른 SQL 용어
서브쿼리는 그 자체가 독립적인 형태로 존재할 수도 있고, 메인쿼리와 끈끈한 관계를 유지하며 존재할 수도 있습니다.

### 비상관 서브쿼리
메인쿼리와 서브쿼리 간에 관계성이 없음을 의미합니다.

서브쿼리가 독자적으로 실행한 뒤 메인쿼리에게 그 결과를 던져주는 형태입니다.

비상관 서브쿼리에서는 서브쿼리가 먼저 실행된 뒤에 그 결과를 메인쿼리가 활용합니다.

즉, 서브쿼리 실행 -> 메인쿼리 실행의 순서로 실행됩니다.

### 상관 서브쿼리
메인쿼리와 서브쿼리 간에 관계성이 있음을 의미합니다.

이러한 상관 서브 쿼리는 SELECT 절에 작성하는 스칼라 서브쿼리와 WHERE 절에 작성하는 중첩 서브쿼리일 때 발생합니다.

## 반환 결과에 따른 SQL 용어
서브쿼리의 결과 유형은 수치적 기준으로 구분할 수 있습니다.

### 단일행 서브쿼리
서브쿼리 결과가 1건의 행으로 반환되는 쿼리입니다.

그에따라 메인쿼리의 조건절에서는 =, <, > 등의 연산자와 비교합니다.

주로 SELECT 절에서 사용하는 스칼라 서브쿼리와 동일하다고 볼 수 있습니다.

### 다중행 서브쿼리
서브쿼리 결과가 여러 건의 행으로 반환되는 쿼리입니다.

그에 따라 메인쿼리의 조건절에서는 IN 구문으로 서브쿼리에서 반환되는 값들을 받습니다.

### 다중열 서브쿼리
서브쿼리 결과가 여러 개의 열과 행으로 반환됩니다.

IN구문과 함께 서브쿼리에서 반환될 열들을 동일하게 나열해 서브쿼리 결과를 받습니다.

## 조인 연산방식 용어
DB에는 다수의 테이블이 있고 필요한 데이터도 여기저기 흩어져 있습니다. 이때 필요한 데이터끼리 결합할 때 조인이라는 방식을 사용합니다.

- 내부 조인 : 양쪽 테이블에 같은 데이터가 있을 때만 결합하는 방식
- 왼쪽 외부 조인 & 오른쪽 외부 조인 : 어느 한쪽에만 데이터가 있어도 데이터를 결합하는 방식
- 전체 외부 조인 : 어느 한쪽에도 해당사항 x
- 교차 조인 : 데카트르 곱, 모든 조인 조합 찾아서 반환
- 자연 조인 : 조건절을 따로 작성하지 않아도 자동으로 조인 수행, 내부 조인과 같은결과
  - 동일한 열 명이 있을땐 내부조인, 아니면 교차 조인

# 2.3 개념적인 튜닝 용어
2.3절에선 오브젝트들을 스캔하는 유형, 디스크 접근 방식 등 쿼리 튜닝과 관련된 용어를 설명합니다.

## 기초 용어
### 오브젝트 스캔 유형
테이블 스캔과 인덱스 스캔으로 구분합니다.

테이블 스캔은 인덱스를 거치지 않고 바로 디스크에 위치한 테이블 데이터에 접근하는 유형이며, 인덱스 스캔은 인덱스로 테이블 데이터를 찾아가는 유형입니다.

- 테이블 풀 스캔
  - 인덱스를 거치지 않고 테이블로 바로 직행하여 처음부터 끝까지 데이터를 훑어보는 방식입니다.
  - WHERE 절의 조건문을 기준으로 활용할 인덱스가 없거나, 전체 데이터 대비 대량의 데이터가 필요할 때 테이블 풀 스캔을 수행할 수 있습니다.
  - 인덱스 없이 사용하는 유일한 방식입니다.
- 인덱스 범위 스캔
  - 인덱스 범위 기준으로 스캔한 뒤 스캔 결과를 토대로 테이블의 데이터를 찾아가는 방식입니다.
  - SQL문에서 BETWEEN~ AND 구문이나 <,>,LIKE 구문 등 비교 연산 및 구문에 포함될 경우 인덱스 범위 스캔으로 수행합니다.
  - 좁은 범위를 스캔할 때는 성능적으로 매우 효율적인 방식이지만 넓은 범위를 스캔할 때는 비효율적인 방식이라고 할 수 있습니다.
- 인덱스 풀 스캔
  - 인덱스를 처음부터 끝까지 수행하는 방식입니다.
  - 단, 테이블에 접근하지 않고 인덱스로 구성된 열 정보만 요구하는 SQL 문에서 인덱스 풀 스캔이 수행됩니다.
  - 인덱스는 테이블보다 상대적으로 적은 양을 차지하므로 테이블 풀 스캔 방식보다는 인덱스 풀 스캔 방식이 성능상 유리합니다.
- 인덱스 고유 스캔
  - 기본 키나 고유 인덱스로 테이블에 접근하는 방식으로, 인덱스를 사용하는 스캔 방식 중 가장 효율적인 스캔 방법입니다.
  - WHERE 절에 = 조건으로 작성하며, 해당 조인 열이 기본 키 또는 고유 인덱스의 선두 열로 선정되었을 때 활용합니다.
- 인덱스 루스 스캔
  - 인덱스의 필요한 부분들만 골라 스캔하는 방식입니다.
  - WHERE 절 조건문 기준으로 필요한 데이터와 필요하지 않은 데이터를 구분한 뒤 불필요한 인덱스 키는 무시합니다.
  - 보통 GROUP BY나 MAX, MIN 함수가 포함되면 작동합니다.
- 인덱스 병합 스캔
  - 테이블 내에 생성된 인덱스들을 통합해서 스캔하는 방식입니다.
  - WHERE문 조건절의 열들이 서로 다른 인덱스로 존재하면 옵티마이저가 해당하는 인덱스를 가져와서 모두 활용하는 방식을 취합니다.

### 디스크 접근 방식
MySQL은 원하는 데이터를 찾으려고 데이터가 저장된 스토리지와 페이지에 접근합니다.

여기서 페이지란 데이터를 검색하는 최소 단위로 페이지 단위로 데이터 읽고 쓰기를 수행할 수 있습니다.

- 시퀀셜 액세스
  - 물리적으로 인접한 페이지를 차례대로 익는 순차 접근 방식입니다. 보통 테이블 풀 스캔에서 활용합니다.
  - 데이터를 찾고자 이동하는 디스크 헤더의 움직임을 최소화하여 작업 시간과 리소스 점유 비용을 줄일 수 있습니다.
- 랜덤 액세스
  - 물리적으로 떨어진 페이지들에 임의로 접근하는 임의 접근 방식입니다. 페이지가 위치한 물리적 위치를 고려하지 않고 접근합니다.
  - 페이지에 접근하는 디스크 헤더가 정해진 순서 없이 이동하는 만큼 디스크의 물리적인 움직임이 필요하고, 다중 페이지 읽기가 불가능하여, 시간이 오래 걸립니다.

## 응용 용어
### 선택도
테이블의 특정 열을 기준으로 해당 열의 조건절에 따라 선택되는 데이터 비율을 의미합니다.

### 카디널리티
전체 데이터에 접근한 뒤 출력될 것이라고 예상하는 데이터 건수입니다.

현업에선 전체 행에 대한 특정 열의 중복 수치를 나타내는 지표로 자주 사용합니다.

카디널리티 = 전체 데이터 건수 x 선택도

> 중복되지 않으면서 많으면 -> 카디널리티 높음

### 힌트
데이터 베이스에게 힌트를 전달함으로써 의도대로 작동하도록 돕는 것입니다.