# ✍🏻 14. 서버를 어떻게 세팅해야 할까?
## 설정해야 하는 대상
개발하는 것 만큼 중요하 것이 서버의 세팅이다.

개발된 프로그램이 0.1초 걸린다고 해도 서버 세팅을 잘못하면 1초가 걸릴 수도 있고, 10초가 걸릴 수 있다.

이러한 문제를 진단하는 가장 좋은 방법은 성능 테스트를 통해서 병목 지점을 미리 파악하는 것이다.

무조건 애플리케이션 위주로 병목을 찾는 것보다, 일단 문제가 될 만한 세팅 값을 먼저 진단하는 것이 가장 효율적이다.

웹 기반의 시스템에서 성능에 영향을 줄만한 세팅을 나열해 보면 다음과 같다.

- 웹 서버 세팅
- WAS 서버 세팅
- DB 서버 세팅
- 장비 세팅

## 아파치 웹 서버의 설정
웹 서버의 세팅을 먼저 알아보자.

WAS를 웹 서버로 사용하면 안 된다.

웹 서버를 WAS 뒤에 둘 사람은 없겠지만, 웹 서버는 반드시 WAS 앞에 두어야 한다.

왜냐하면 WAS는 Web Application Server이기 때문이다. 웹에서 사용하는 애플리케이션 서버지 웹 서버가 아니다.

정적인 부분은 웹 서버에서 처리해야 한다. 그렇지 않으면 WAS 서버에서 웹 서버의 역할까지 수행해야 한다.

웹 서버를 WAS 서버 앞에 두지 않으면 이미지, CSS, 자바 스크립트, HTML 등을 처리하느라 아까운 `WAS 서버의 스레드를 점유하게 된다.`

간혹 그럴필요가 없다고 하는 분들이 있긴 하지만, 웹 서버 하나에 WAS가 두개이상 연동되는 경우 등을 고려하면 웹서버를 앞 단에 두는 것이 좋다.

## DB Connection Pool 및 스레드 개수 설정
WAS에서 설정해야 하는 값은 너무나 많다.

그중 가장 성능에 많은 영향을 주는 DB Connetion Pool과 스레드 개수에 대해 알아보자.

이 두 항목의 개수는 메모리와 관련이 있다.

많이 사용할수록 메모리를 많이 점유하게 된다. 그렇다고 메모리를 위해서 DB Connection Pool과 스레드 개수를 적게 지정하면, 서버에서는 많은 요청을 처리하지 못하고 대기할 수밖에 없다.

대부분의 WAS에서는 DB Connection Pool의 개수를 최소치, 증가치, 최대치 등으로 자세하게 지정할 수 있다.

최소치는 말 그대로 서버가 기동될 때 연결을 수행하는 개수이다. 개발자용 PC에서는 이 값이 높을 필요가 없으므로 이 값은 최소한으로 지정하도록 하자.

최소 개수가 많으면 많을수록 서버 기동하는 시간이 오래 소요되므로, 개발자가 디버그를 하기 위해서 여러 번 재기동을 할 때는 좋지 않다.

하지만 운영 중에는 최소 및 최대 값을 동일하게 하는 것이 좋다. 사용자 수가 갑자기 증가하면 DB Connection Pool의 개수도 증가되어야 하고, 증가할 때 대기 시간이 발생할 확률이 크기 때문이다.

만약 DB 서버의 리소스가 부족하다면 최소 값을 적게 해 놓는 것도 한 방법이 될 수 있다.

대부분 WAS에서 두 설정 값의 기본 개수가 10~20개 정도이다.

따라서 기본 값으로 서비스를 오픈하면 서버가 원하는 요청량을 처리하지 못하게 된다. 

DB Connection Pool은 보통 40~50개로 지정하며, 스레드 개수느 이보다 10개 정도 더 지정한다.

이렇게 지정하는 이유는, 스레드 개수가 DB Connection Pool의 개수보다 적으면 적은 수만큼의 연결은 필요 없기 때문이다.

쉽게 스레드는 입구이고 DB Connection Pool은 출구라고 생각하면 된다.

그럼 가장 적합한 DB Connection Pool과 스레드 개수는 몇 개일까?

웹 서버의 세팅 값도 그렇지만, 이 수치도 서버와 애플리케이션 상황에 따라 다르며, 완벽한 값은 없다.

서비스 및 서버의 상황에 맞게 값을 지정해야 하는 것이다. 가장 좋은 방법은 성능 테스트를 통해서 가장 적절한 값을 구하는 것이다.

DB Connection Pool의 개수를 기준으로 적절한 수치를 찾는 방법을 생각해보자.

DB Connection Pool 을 40개로 잡아 놓았다고 가정하자.

40개 전부를 사용하면서 DB의 CPU 사용량이 100%에 도달했다면, 어떻게 해야 할까?

이 경우에는 DB의 CPU를 점유하는 쿼리를 찾아서 튜닝해야 한다.

다시 말하면, 인덱스가 없거나 테이블을 풀 스캔하는 쿼리가 있는 것은 아닌지 쿼리의 플랜을 떠서 확인해 봐야 한다.

40개를 전부 사용한다고 해서 DB Connection Pool 개수를 80~200개로 늘리면, 모든 DB와의 연결을 전부 사용하고 응답 시간은 엄청나게 느려질 뿐이다.

이번에는 DB의 CPU 사용량은 50%도 되지 않는 상황에서 WAS의 CPU 사용량이 100%에 도달하고 있는 상황을 생각해 보자.

그때 사용하는 DB Connection Pool의 개수는 20개 정도 밖에 되지 않는다. 

이럴 때는 어떻게 할까? 이 경우에는 WAS의 애플리케이션을 튜닝해야 한다.

하지만 이미 튜닝이 된 상태라면 이 서버의 DB Connection Pool의 개수는 약간의 여유를 두기 위해서 25~30개 정도로 지정하는 것이 좋다.

Connection Pool의 개수만큼 중요한 값이 있다. 바로 대기 시간과 관련된 값이다.

DB Connection Pool의 개수를 넘어 섰을 때 애플리케이션에서는 '어디 남는 Connection'없나? 하고 두리번거리면서 기다린다.

그런데, 이 기다리는 시간이 바로 대기시간이다.

MyBatis에선 poolTimeToWait라는 값으로 이 대기시간을 결정하며, 기본은 20초다. 다시 말해서 이 값을 그냥 놔 둘 경우 DB 연결을 못해 기다리는 사용자들이 적어도 20초는 대기해야 한다는 말이다.

그렇다고 대기 시간을 아주 짧게 하면 어떨까? 예를 들어 100ms 정도로 줬다고 가정하자.

필자가 지금까지 GC 튜닝을 한 경험을 토대로 얘기하면 메모리를 1GB로 할당한 WAS에서 300ms 이하의 Full GC 시간을 만들기는 매우 어렵다.

만약 DB 연결을 하려고 대기 하는 순간 Full GC가 발생하면 그 순간에 대기하고 있는 모든 스레드는 DB와 연결을 못했다고 Timeout을 뿜을 수도 있다.
